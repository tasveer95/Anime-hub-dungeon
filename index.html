<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Babylon Hub ‚Üí Dungeon (Working)</title>
  <style>
    html,body{height:100%;margin:0;overflow:hidden;background:#070A12;font-family:system-ui,Segoe UI,Roboto,Arial;color:#eef3ff;}
    #wrap{position:relative;width:100vw;height:100vh;}
    canvas{position:absolute;inset:0;width:100vw;height:100vh;display:block;}
    #hud{
      position:absolute;left:16px;top:16px;width:360px;z-index:5;
      background:rgba(10,14,26,.72);border:1px solid rgba(255,255,255,.14);
      border-radius:18px;padding:14px;backdrop-filter:blur(10px);
      box-shadow:0 18px 55px rgba(0,0,0,.45);user-select:none;
    }
    .row{display:flex;justify-content:space-between;align-items:center}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.05);font-size:12px;color:rgba(235,241,255,.78)}
    .hint{margin-top:10px;font-size:12px;color:rgba(235,241,255,.72);line-height:1.35}
    #attackBtn{
      position:absolute;right:22px;bottom:120px;width:120px;height:120px;border-radius:999px;z-index:5;
      border:1px solid rgba(255,255,255,.18);
      background:radial-gradient(circle at 40% 35%, rgba(255,220,140,.22), rgba(255,208,102,.08) 55%, rgba(10,14,26,.55));
      backdrop-filter:blur(10px);box-shadow:0 18px 55px rgba(0,0,0,.45);
      display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
    }
    #attackBtn:active{transform:translateY(1px) scale(.99)}
    #toast{
      position:absolute;left:50%;top:16px;transform:translateX(-50%);z-index:6;
      width:min(680px, calc(100vw - 30px));
      padding:10px 14px;border-radius:16px;border:1px solid rgba(255,255,255,.14);
      background:rgba(10,14,26,.65);backdrop-filter:blur(10px);
      box-shadow:0 18px 55px rgba(0,0,0,.45);text-align:center;
      opacity:0;transition:opacity .18s ease;
      color:rgba(235,241,255,.82);font-weight:700;
    }
    #toast.show{opacity:1}
  </style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <div id="toast"></div>

  <div id="hud">
    <div class="row">
      <div style="font-weight:900;">Prototype</div>
      <div class="chip" id="zoneChip">Zone: Start</div>
    </div>
    <div class="hint">
      Click the game ‚Üí mouse look. Move: <b>WASD / Arrows</b> ¬∑ Sprint: <b>Shift</b><br/>
      Attack: <b>Space / Click / Tap</b>. Walk into the glowing portal.
    </div>
  </div>

  <div id="attackBtn">üó°Ô∏è Attack</div>
</div>

<!-- Babylon (NO modules, stable) -->
<script src="https://cdn.babylonjs.com/babylon.js"></script>

<script>
(() => {
  const toast = document.getElementById("toast");
  const zoneChip = document.getElementById("zoneChip");
  const attackBtn = document.getElementById("attackBtn");

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
  }
  function fatal(msg){
    console.error(msg);
    toast.textContent = "‚ùå " + msg;
    toast.classList.add("show");
  }

  // Fail-loud checks
  window.addEventListener("error", (e) => fatal(e.message || "Unknown JS error"));
  window.addEventListener("unhandledrejection", (e) => fatal((e.reason && e.reason.message) ? e.reason.message : "Promise error"));

  if (!window.BABYLON) { fatal("Babylon.js failed to load (CDN blocked). Disable adblock or try another network."); return; }
  if (!BABYLON.Engine.isSupported()) { fatal("WebGL not supported/disabled. Check Chrome settings or GPU drivers."); return; }

  const canvas = document.getElementById("game");
  const engine = new BABYLON.Engine(canvas, true);

  const GAME = { zone:"start", wood:0, stone:0 };
  function setZone(z){
    GAME.zone = z;
    zoneChip.textContent = "Zone: " + (z==="start" ? "Start" : "Dungeon");
  }

  const scene = new BABYLON.Scene(engine);
  scene.clearColor = new BABYLON.Color4(0.03,0.04,0.08,1);

  // Fog
  scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
  scene.fogDensity = 0.010;
  scene.fogColor = new BABYLON.Color3(0.03,0.04,0.08);

  // Lights
  const hemi = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);
  hemi.intensity = 0.95;
  const sun = new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(-0.4,-1,-0.25), scene);
  sun.position = new BABYLON.Vector3(20,30,20);
  sun.intensity = 1.15;

  function flatMat(hex){
    const m = new BABYLON.StandardMaterial("m", scene);
    const c = BABYLON.Color3.FromHexString(hex);
    m.diffuseColor = c;
    m.specularColor = new BABYLON.Color3(0.05,0.05,0.05);
    m.emissiveColor = c.scale(0.08);
    return m;
  }

  // Camera (ArcRotate, smooth)
  const camera = new BABYLON.ArcRotateCamera("cam",
    BABYLON.Tools.ToRadians(180),
    BABYLON.Tools.ToRadians(65),
    22,
    new BABYLON.Vector3(0,1.7,0),
    scene
  );
  camera.lowerRadiusLimit = 14;
  camera.upperRadiusLimit = 30;
  camera.panningSensibility = 0;
  camera.inertia = 0.85;
  camera.angularSensibilityX = 2600;
  camera.angularSensibilityY = 2600;
  camera.attachControl(canvas, true);

  // Pointer lock on click
  canvas.addEventListener("click", () => {
    if (document.pointerLockElement !== canvas) canvas.requestPointerLock?.();
  });

  // Collisions
  scene.collisionsEnabled = true;

  // Player
  const player = BABYLON.MeshBuilder.CreateCylinder("player",{ height:1.9, diameter:1.2, tessellation:16 }, scene);
  player.position = new BABYLON.Vector3(0, 1.0, 40);
  player.material = flatMat("#D6E1FF");
  player.checkCollisions = true;
  player.ellipsoid = new BABYLON.Vector3(0.55, 0.95, 0.55);
  player.ellipsoidOffset = new BABYLON.Vector3(0, 0.95, 0);
  camera.lockedTarget = player;

  const head = BABYLON.MeshBuilder.CreateSphere("head",{ diameter:0.85, segments:16 }, scene);
  head.parent = player;
  head.position = new BABYLON.Vector3(0, 0.95, 0);
  head.material = flatMat("#A9C2FF");

  // Zone roots
  const startRoot = new BABYLON.TransformNode("startRoot", scene);
  const dungeonRoot = new BABYLON.TransformNode("dungeonRoot", scene);
  dungeonRoot.setEnabled(false);

  // Start ground
  const startGround = BABYLON.MeshBuilder.CreateGround("startGround",{ width:220, height:220 }, scene);
  startGround.parent = startRoot;
  startGround.checkCollisions = true;
  startGround.material = flatMat("#121a2f");

  // Portal gate
  const gate = new BABYLON.TransformNode("gate", scene);
  gate.position = new BABYLON.Vector3(0,0,-70);
  gate.parent = startRoot;

  const torus = BABYLON.MeshBuilder.CreateTorus("torus",{ diameter:10.4, thickness:0.75, tessellation:48 }, scene);
  torus.parent = gate;
  torus.rotation.x = Math.PI/2;
  torus.position.y = 3.6;
  torus.material = flatMat("#6a7db0");

  const portal = BABYLON.MeshBuilder.CreateDisc("portal",{ radius:4.3, tessellation:64 }, scene);
  portal.parent = gate;
  portal.rotation.x = Math.PI/2;
  portal.position.y = 3.6;
  const portalMat = flatMat("#0a1020");
  portalMat.emissiveColor = BABYLON.Color3.FromHexString("#66f2b9").scale(0.8);
  portal.material = portalMat;

  const portalLight = new BABYLON.PointLight("portalLight", new BABYLON.Vector3(0,3.6,-70), scene);
  portalLight.diffuse = BABYLON.Color3.FromHexString("#66f2b9");
  portalLight.intensity = 1.2;
  portalLight.range = 26;

  // Dungeon floor
  const dungeonFloor = BABYLON.MeshBuilder.CreateGround("dungeonFloor",{ width:110, height:240 }, scene);
  dungeonFloor.parent = dungeonRoot;
  dungeonFloor.position = new BABYLON.Vector3(0,0,-140);
  dungeonFloor.checkCollisions = true;
  dungeonFloor.material = flatMat("#0f1220");

  // Simple dungeon walls
  function wall(x,y,z,w,h,d){
    const m = BABYLON.MeshBuilder.CreateBox("wall",{ width:w, height:h, depth:d }, scene);
    m.position = new BABYLON.Vector3(x,y,z);
    m.material = flatMat("#1a2240");
    m.checkCollisions = true;
    m.parent = dungeonRoot;
    return m;
  }
  wall(-14, 2.7, -110, 2.5, 5.4, 90);
  wall( 14, 2.7, -110, 2.5, 5.4, 90);

  // Breakables + loot
  const breakables = [];
  const loot = [];

  function spawnCrate(x,z){
    const c = BABYLON.MeshBuilder.CreateBox("crate",{ size:1.6 }, scene);
    c.position = new BABYLON.Vector3(x, 0.8, z);
    c.material = flatMat("#7b5630");
    c.parent = dungeonRoot;
    c.metadata = { hp:2 };
    breakables.push(c);
  }
  for (let i=0;i<10;i++){
    spawnCrate((Math.random()-0.5)*22, -200 + (Math.random()-0.5)*22);
  }

  function spawnLoot(type, x, z){
    const s = BABYLON.MeshBuilder.CreateSphere("loot",{ diameter:0.65, segments:12 }, scene);
    s.position = new BABYLON.Vector3(x, 1.35, z);
    const mat = flatMat(type==="wood" ? "#66f2b9" : "#ffd066");
    mat.emissiveColor = BABYLON.Color3.FromHexString(type==="wood" ? "#66f2b9" : "#ffd066").scale(0.9);
    s.material = mat;
    s.parent = dungeonRoot;

    const l = new BABYLON.PointLight("lootLight", s.position.clone(), scene);
    l.diffuse = BABYLON.Color3.FromHexString(type==="wood" ? "#66f2b9" : "#ffd066");
    l.intensity = 0.9;
    l.range = 12;

    loot.push({ type, mesh:s, light:l, t:Math.random()*10 });
  }

  // Input
  const keys = new Set();
  window.addEventListener("keydown", (e)=>keys.add(e.key.toLowerCase()));
  window.addEventListener("keyup", (e)=>keys.delete(e.key.toLowerCase()));

  // Attack
  let attackCd = 0;
  function doAttack(){
    if (attackCd > 0) return;
    attackCd = 0.22;

    // Hit nearby crates in dungeon
    if (GAME.zone !== "dungeon") return;

    const hitR = 2.9;
    for (let i=breakables.length-1;i>=0;i--){
      const b = breakables[i];
      if (!b || b.isDisposed()) { breakables.splice(i,1); continue; }

      const d = BABYLON.Vector3.Distance(player.position, b.position);
      if (d <= hitR){
        b.metadata.hp -= 1;
        b.position.x += (Math.random()<0.5?-0.15:0.15);
        b.position.z += (Math.random()<0.5?-0.15:0.15);

        if (b.metadata.hp <= 0){
          const bx = b.position.x, bz = b.position.z;
          b.dispose();
          breakables.splice(i,1);
          spawnLoot("wood", bx + (Math.random()-0.5)*0.8, bz + (Math.random()-0.5)*0.8);
          if (Math.random() < 0.65) spawnLoot("stone", bx + (Math.random()-0.5)*0.8, bz + (Math.random()-0.5)*0.8);
        }
      }
    }
  }
  window.addEventListener("keydown", (e)=>{ if (e.code==="Space"){ e.preventDefault(); doAttack(); }});
  attackBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); doAttack(); });

  // Game loop
  let last = performance.now();
  showToast("Click to enable mouse look. Walk into the glowing portal.");

  scene.onBeforeRenderObservable.add(() => {
    const now = performance.now();
    const dt = Math.min(0.05, (now-last)/1000);
    last = now;

    // Portal pulse
    portalMat.emissiveColor = BABYLON.Color3.FromHexString("#66f2b9").scale(0.55 + 0.35*Math.sin(now*0.003));

    // Movement (correct, not reversed)
    const sprint = keys.has("shift");
    const speed = sprint ? 10.0 : 7.4;

    let mx=0, mz=0;
    if (keys.has("a") || keys.has("arrowleft"))  mx -= 1;
    if (keys.has("d") || keys.has("arrowright")) mx += 1;
    if (keys.has("w") || keys.has("arrowup"))    mz += 1; // forward
    if (keys.has("s") || keys.has("arrowdown"))  mz -= 1; // back

    const len = Math.hypot(mx,mz);
    if (len > 0){ mx/=len; mz/=len; }

    const yaw = camera.alpha;
    const forward = new BABYLON.Vector3(-Math.sin(yaw), 0, -Math.cos(yaw)); // forward is -Z
    const right   = new BABYLON.Vector3( Math.cos(yaw), 0, -Math.sin(yaw));

    const wish = right.scale(mx).add(forward.scale(mz)).scale(speed);
    player.moveWithCollisions(new BABYLON.Vector3(wish.x*dt, 0, wish.z*dt));

    // Face direction
    if (len > 0.1){
      const face = Math.atan2(wish.x, wish.z);
      player.rotation.y = BABYLON.Scalar.LerpAngle(player.rotation.y, face, 0.18);
    }

    // Zone trigger
    if (GAME.zone === "start"){
      const dx = player.position.x - gate.getAbsolutePosition().x;
      const dz = player.position.z - gate.getAbsolutePosition().z;
      if (dx*dx + dz*dz < 4.7*4.7){
        player.position = new BABYLON.Vector3(0, 1.0, -135);
        startRoot.setEnabled(false);
        dungeonRoot.setEnabled(true);
        scene.fogDensity = 0.016;
        scene.fogColor = new BABYLON.Color3(0.015,0.02,0.05);
        setZone("dungeon");
        showToast("Entered the dungeon.");
      }
    }

    // Loot magnet pickup
    if (GAME.zone === "dungeon"){
      const MAG = 2.6;
      for (let i=loot.length-1;i>=0;i--){
        const p = loot[i];
        if (!p.mesh || p.mesh.isDisposed()){ loot.splice(i,1); continue; }
        p.t += dt;
        p.mesh.position.y = 1.35 + Math.sin(p.t*3.2)*0.16;
        p.light.position.copyFrom(p.mesh.position);

        const d = BABYLON.Vector3.Distance(player.position, p.mesh.position);
        if (d < MAG){
          p.mesh.position.x = BABYLON.Scalar.Lerp(p.mesh.position.x, player.position.x, 0.18);
          p.mesh.position.z = BABYLON.Scalar.Lerp(p.mesh.position.z, player.position.z, 0.18);
          if (d < 0.55){
            if (p.type==="wood") GAME.wood++; else GAME.stone++;
            p.light.dispose(); p.mesh.dispose(); loot.splice(i,1);
          }
        }
      }
    }
  });

  engine.runRenderLoop(() => scene.render());
  window.addEventListener("resize", () => engine.resize());
})();
</script>
</body>
</html>
