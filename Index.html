<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Anime Hub ‚Üí Dungeon (Babylon Prototype)</title>
  <style>
    :root{
      --bg:#070A12;
      --glass: rgba(10,14,26,0.72);
      --stroke: rgba(255,255,255,0.14);
      --text: rgba(235,241,255,0.92);
      --muted: rgba(235,241,255,0.68);
      --good: rgba(102,242,185,0.96);
      --gold: rgba(255,208,102,0.96);
      --shadow: 0 18px 55px rgba(0,0,0,0.45);
      --r: 18px;
    }
    html,body{height:100%;margin:0;background: radial-gradient(1100px 800px at 35% 20%, #203070 0%, var(--bg) 55%); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; overflow:hidden;}
    #wrap{position:relative; width:100vw; height:100vh;}
    canvas{display:block; width:100vw; height:100vh;}

    #hud{
      position:absolute; left:16px; top:16px; width:360px;
      background: var(--glass);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:14px;
      user-select:none;
      z-index:20;
    }
    .hudTitle{display:flex; justify-content:space-between; align-items:center; font-weight:800;}
    .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background: rgba(255,255,255,0.05); color:var(--muted); font-size:12px;}
    .barWrap{margin-top:10px; padding:10px; border-radius:14px; border:1px solid var(--stroke); background: rgba(255,255,255,0.05);}
    .barLabel{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .hpBar{height:12px; border-radius:999px; background: rgba(255,255,255,0.08); overflow:hidden; border:1px solid rgba(255,255,255,0.10);}
    .hpFill{height:100%; width:100%; background: linear-gradient(90deg, rgba(255,90,90,0.95), rgba(102,242,185,0.95));}
    .row{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;}
    .card{flex:1; min-width:160px; padding:10px; border-radius:14px; border:1px solid var(--stroke); background: rgba(255,255,255,0.05);}
    .k{font-size:12px; color:var(--muted); margin-bottom:4px;}
    .v{font-size:14px; font-weight:800; display:flex; align-items:center; gap:8px;}
    .good{color:var(--good); font-weight:800;}
    .gold{color:var(--gold); font-weight:800;}
    .hint{margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35;}

    #topRight{
      position:absolute; right:16px; top:16px;
      display:flex; flex-direction:column; gap:10px;
      z-index:20;
    }
    .counter{
      display:flex; align-items:center; justify-content:space-between;
      min-width:170px;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: var(--glass);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .counterLeft{display:flex; align-items:center; gap:10px;}
    .icon{width:22px;height:22px;border-radius:7px;background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); display:grid; place-items:center;}
    .count{font-weight:900; font-size:18px;}
    .plus{width:26px;height:26px;border-radius:8px;border:1px solid rgba(255,255,255,0.20);background: rgba(102,242,185,0.12);display:flex;align-items:center;justify-content:center;color: var(--good);font-weight:900;}

    #attackBtn{
      position:absolute; right:22px; bottom:120px;
      width:120px; height:120px; border-radius: 999px;
      border:1px solid rgba(255,255,255,0.18);
      background: radial-gradient(circle at 40% 35%, rgba(255,220,140,0.22), rgba(255,208,102,0.08) 55%, rgba(10,14,26,0.55));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:flex; align-items:center; justify-content:center;
      z-index:20;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
    }
    #attackBtn:active{transform: translateY(1px) scale(0.99);}
    .attackInner{
      width:92px; height:92px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:6px;
    }
    .attackLabel{font-weight:900; color:var(--gold);}
    .small{font-size:11px; color:var(--muted); font-weight:700;}

    #toast{
      position:absolute; left:50%; top:16px; transform: translateX(-50%);
      width:min(520px, calc(100vw - 30px));
      padding:10px 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(10,14,26,0.55);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      z-index:20;
      opacity:0; transform: translate(-50%, -6px);
      transition: opacity .18s ease, transform .18s ease;
      pointer-events:none;
      text-align:center;
      color: var(--muted);
      font-weight:700;
    }
    #toast.show{opacity:1; transform: translate(-50%, 0);}

    #feed{
      position:absolute; left:50%; bottom:22px; transform: translateX(-50%);
      width:min(760px, calc(100vw - 30px));
      display:flex; flex-direction:column; gap:10px;
      z-index:20;
      pointer-events:none;
    }
    .feedItem{
      display:flex; align-items:center; gap:12px;
      padding:10px 14px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: rgba(10,14,26,0.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 55px rgba(0,0,0,0.40);
      opacity:0;
      transform: translateY(10px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .feedItem.show{opacity:1; transform: translateY(0);}
    .feedText{font-weight:800;}
    .feedSub{color:var(--muted); font-size:12px; margin-left:auto;}

    @media (max-width: 820px){
      #hud{width: 330px;}
      #attackBtn{right:16px; bottom:100px; width:108px; height:108px;}
      .attackInner{width:84px; height:84px;}
    }
  </style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>

  <div id="toast"></div>

  <div id="hud">
    <div class="hudTitle">
      <div>Prototype</div>
      <div class="chip" id="zoneChip">Zone: Start</div>
    </div>

    <div class="barWrap">
      <div class="barLabel">HP <span class="gold" id="hpText">10/10</span></div>
      <div class="hpBar"><div class="hpFill" id="hpFill"></div></div>
    </div>

    <div class="row">
      <div class="card">
        <div class="k">Resources</div>
        <div class="v"><span class="gold" id="woodText">0</span> wood ¬∑ <span class="gold" id="stoneText">0</span> stone</div>
      </div>
      <div class="card">
        <div class="k">Controls</div>
        <div class="v">
          <span class="good">Click</span> to look ¬∑ <span class="good">WASD / Arrows</span>
        </div>
      </div>
    </div>

    <div class="hint">
      Sprint: <span class="good">Shift</span> ¬∑ Attack: <span class="good">Space / Click</span><br/>
      Walk into the <span class="gold">portal gate</span> to reach the dungeon.
    </div>
  </div>

  <div id="topRight">
    <div class="counter">
      <div class="counterLeft">
        <span class="icon">ü™µ</span>
        <div class="count" id="woodCount">0</div>
      </div>
      <div class="plus">+</div>
    </div>
    <div class="counter">
      <div class="counterLeft">
        <span class="icon">ü™®</span>
        <div class="count" id="stoneCount">0</div>
      </div>
      <div class="plus">+</div>
    </div>
  </div>

  <div id="feed"></div>

  <div id="attackBtn" aria-label="Attack">
    <div class="attackInner">
      <div style="font-size:26px">üó°Ô∏è</div>
      <div class="attackLabel">Attack</div>
      <div class="small">Space / Tap</div>
    </div>
  </div>
</div>

<!-- Babylon CDN -->
<script src="https://cdn.babylonjs.com/babylon.js"></script>

<script>
(() => {
  const canvas = document.getElementById("game");
  const engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });

  // UI
  const ui = {
    zoneChip: document.getElementById("zoneChip"),
    hpText: document.getElementById("hpText"),
    hpFill: document.getElementById("hpFill"),
    woodText: document.getElementById("woodText"),
    stoneText: document.getElementById("stoneText"),
    woodCount: document.getElementById("woodCount"),
    stoneCount: document.getElementById("stoneCount"),
    toast: document.getElementById("toast"),
    feed: document.getElementById("feed"),
    attackBtn: document.getElementById("attackBtn"),
  };

  let toastTimer = null;
  function showToast(msg){
    ui.toast.textContent = msg;
    ui.toast.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => ui.toast.classList.remove("show"), 1400);
  }
  function pushFeed(icon, text){
    const item = document.createElement("div");
    item.className = "feedItem";
    item.innerHTML = `<div style="font-size:20px">${icon}</div><div class="feedText">${text}</div><div class="feedSub">Collected</div>`;
    ui.feed.prepend(item);
    requestAnimationFrame(()=>item.classList.add("show"));
    setTimeout(()=>{ item.classList.remove("show"); setTimeout(()=>item.remove(), 220); }, 1200);
  }

  const GAME = { zone:"start", hp:10, hpMax:10, wood:0, stone:0 };
  function syncUI(){
    ui.zoneChip.textContent = `Zone: ${GAME.zone === "start" ? "Start" : "Dungeon"}`;
    ui.hpText.textContent = `${GAME.hp}/${GAME.hpMax}`;
    ui.hpFill.style.width = `${(GAME.hp/GAME.hpMax)*100}%`;
    ui.woodText.textContent = GAME.wood;
    ui.stoneText.textContent = GAME.stone;
    ui.woodCount.textContent = GAME.wood;
    ui.stoneCount.textContent = GAME.stone;
  }

  // Helpers: ‚Äúanime-ish‚Äù flat materials + soft fog
  function flatMat(scene, hex){
    const m = new BABYLON.StandardMaterial("m", scene);
    const c = BABYLON.Color3.FromHexString(hex);
    m.diffuseColor = c;
    m.specularColor = new BABYLON.Color3(0.05,0.05,0.05);
    m.emissiveColor = c.scale(0.08); // subtle ‚Äútoon glow‚Äù
    return m;
  }

  // Scene
  const createScene = () => {
    const scene = new BABYLON.Scene(engine);
    scene.clearColor = new BABYLON.Color4(0.03,0.04,0.08,1);
    scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
    scene.fogDensity = 0.008;
    scene.fogColor = new BABYLON.Color3(0.03,0.04,0.08);

    // Lights
    const hemi = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);
    hemi.intensity = 0.9;
    hemi.groundColor = new BABYLON.Color3(0.02,0.02,0.03);

    const sun = new BABYLON.DirectionalLight("sun", new BABYLON.Vector3(-0.4,-1,-0.2), scene);
    sun.position = new BABYLON.Vector3(20,30,20);
    sun.intensity = 1.15;

    // Camera: smooth follow 3rd-person
    const camera = new BABYLON.ArcRotateCamera("cam",
      BABYLON.Tools.ToRadians(180),
      BABYLON.Tools.ToRadians(65),
      22,
      new BABYLON.Vector3(0,1.7,0),
      scene
    );
    camera.lowerRadiusLimit = 14;
    camera.upperRadiusLimit = 30;
    camera.wheelDeltaPercentage = 0.01;
    camera.attachControl(canvas, true);
    camera.panningSensibility = 0;
    camera.inertia = 0.85;
    camera.angularSensibilityX = 2600;
    camera.angularSensibilityY = 2600;

    // Pointer lock on click
    canvas.addEventListener("click", () => {
      if (document.pointerLockElement !== canvas) canvas.requestPointerLock?.();
    });

    // Enable collisions
    scene.collisionsEnabled = true;

    // Player ‚Äúcapsule-ish‚Äù (no special geometry to break)
    const player = BABYLON.MeshBuilder.CreateCylinder("player", {
      height: 1.9, diameter: 1.2, tessellation: 16
    }, scene);
    player.position = new BABYLON.Vector3(0, 1.0, 40);
    player.checkCollisions = true;
    player.ellipsoid = new BABYLON.Vector3(0.55, 0.95, 0.55);
    player.ellipsoidOffset = new BABYLON.Vector3(0, 0.95, 0);
    player.material = flatMat(scene, "#D6E1FF");

    const head = BABYLON.MeshBuilder.CreateSphere("head", { diameter: 0.85, segments: 16 }, scene);
    head.parent = player;
    head.position = new BABYLON.Vector3(0, 0.95, 0);
    head.material = flatMat(scene, "#A9C2FF");

    const buddy = BABYLON.MeshBuilder.CreateSphere("buddy", { diameter: 0.38, segments: 14 }, scene);
    buddy.parent = player;
    buddy.position = new BABYLON.Vector3(-0.9, 0.55, 0.4);
    buddy.material = flatMat(scene, "#50C8A0");

    // Follow target
    camera.lockedTarget = player;

    // Gravity
    const gravity = new BABYLON.Vector3(0, -0.5, 0);
    let velocityY = 0;

    // Zones
    const startRoot = new BABYLON.TransformNode("startRoot", scene);
    const dungeonRoot = new BABYLON.TransformNode("dungeonRoot", scene);
    dungeonRoot.setEnabled(false);

    // Start ground
    const startGround = BABYLON.MeshBuilder.CreateGround("startGround", { width: 220, height: 220 }, scene);
    startGround.material = flatMat(scene, "#121a2f");
    startGround.checkCollisions = true;
    startGround.parent = startRoot;

    // Start rocks
    const rockMat = flatMat(scene, "#2a3554");
    for (let i=0;i<28;i++){
      const r = BABYLON.MeshBuilder.CreatePolyhedron("r"+i, { type: 2, size: 1.0 + Math.random()*1.6 }, scene);
      r.position = new BABYLON.Vector3((Math.random()-0.5)*90, 1.0 + Math.random()*1.2, (Math.random()-0.5)*80);
      r.rotation = new BABYLON.Vector3(Math.random(), Math.random(), Math.random());
      r.material = rockMat;
      r.parent = startRoot;
      r.checkCollisions = true;
    }

    // Portal gate
    const gate = new BABYLON.TransformNode("gate", scene);
    gate.position = new BABYLON.Vector3(0,0,-70);
    gate.parent = startRoot;

    const torus = BABYLON.MeshBuilder.CreateTorus("torus", { diameter: 10.4, thickness: 0.75, tessellation: 48 }, scene);
    torus.rotation.x = Math.PI/2;
    torus.position.y = 3.6;
    torus.material = flatMat(scene, "#6a7db0");
    torus.parent = gate;

    const pMat = flatMat(scene, "#2a3554");
    const pillarL = BABYLON.MeshBuilder.CreateCylinder("pillarL",{ height:7.2, diameterTop:1.2, diameterBottom:1.5, tessellation:14 },scene);
    pillarL.position = new BABYLON.Vector3(-4.4, 3.6, 0); pillarL.material = pMat; pillarL.parent = gate; pillarL.checkCollisions = true;
    const pillarR = pillarL.clone("pillarR"); pillarR.position.x = 4.4; pillarR.parent = gate;

    // Portal disc with emissive ‚Äúswirl‚Äù
    const portal = BABYLON.MeshBuilder.CreateDisc("portal",{ radius:4.3, tessellation:64 },scene);
    portal.rotation.x = Math.PI/2;
    portal.position = new BABYLON.Vector3(0, 3.6, 0);
    portal.parent = gate;

    const portalMat = new BABYLON.StandardMaterial("portalMat", scene);
    portalMat.emissiveColor = BABYLON.Color3.FromHexString("#66f2b9");
    portalMat.diffuseColor = BABYLON.Color3.FromHexString("#0a1020");
    portalMat.alpha = 0.92;
    portal.material = portalMat;

    const portalLight = new BABYLON.PointLight("portalLight", new BABYLON.Vector3(0,3.6,-70), scene);
    portalLight.diffuse = BABYLON.Color3.FromHexString("#66f2b9");
    portalLight.intensity = 1.15;
    portalLight.range = 24;

    // Dungeon
    const dungeonFloor = BABYLON.MeshBuilder.CreateGround("dungeonFloor", { width: 110, height: 240 }, scene);
    dungeonFloor.position = new BABYLON.Vector3(0,0,-140);
    dungeonFloor.material = flatMat(scene, "#0f1220");
    dungeonFloor.checkCollisions = true;
    dungeonFloor.parent = dungeonRoot;

    function wall(x,y,z,w,h,d){
      const m = BABYLON.MeshBuilder.CreateBox("wall",{ width:w, height:h, depth:d },scene);
      m.position = new BABYLON.Vector3(x,y,z);
      m.material = flatMat(scene, "#1a2240");
      m.checkCollisions = true;
      m.parent = dungeonRoot;
      return m;
    }
    wall(-14, 2.7, -110, 2.5, 5.4, 90);
    wall( 14, 2.7, -110, 2.5, 5.4, 90);
    wall( 0, 2.7, -210, 40, 5.4, 2.5);
    wall(-20, 2.7, -190, 2.5, 5.4, 40);
    wall( 20, 2.7, -190, 2.5, 5.4, 40);

    function lantern(x,z){
      const pole = BABYLON.MeshBuilder.CreateCylinder("pole",{ height:2.3, diameterTop:0.36, diameterBottom:0.44, tessellation:12 },scene);
      pole.position = new BABYLON.Vector3(x, 1.15, z);
      pole.material = rockMat;
      pole.parent = dungeonRoot;

      const lamp = BABYLON.MeshBuilder.CreateSphere("lamp",{ diameter:0.72, segments:14 },scene);
      lamp.position = new BABYLON.Vector3(x, 2.25, z);
      lamp.material = flatMat(scene, "#ffd066");
      lamp.parent = dungeonRoot;

      const l = new BABYLON.PointLight("lanternLight", new BABYLON.Vector3(x,2.25,z), scene);
      l.diffuse = BABYLON.Color3.FromHexString("#ffd066");
      l.intensity = 0.95;
      l.range = 20;
    }
    lantern(-8, -130);
    lantern( 8, -155);
    lantern( 0, -185);

    // Breakables + Loot
    const breakables = [];
    const loot = [];

    const crateMat = flatMat(scene, "#7b5630");

    function spawnCrate(x,z){
      const c = BABYLON.MeshBuilder.CreateBox("crate",{ size:1.6 },scene);
      c.position = new BABYLON.Vector3(x, 0.8, z);
      c.material = crateMat;
      c.parent = dungeonRoot;
      c.metadata = { hp:2 };
      breakables.push(c);
    }
    for (let i=0;i<12;i++){
      spawnCrate((Math.random()-0.5)*22, -200 + (Math.random()-0.5)*22);
    }

    function spawnLoot(type, x, z){
      const s = BABYLON.MeshBuilder.CreateSphere("loot",{ diameter:0.65, segments:12 },scene);
      s.position = new BABYLON.Vector3(x, 1.35, z);
      s.material = flatMat(scene, type === "wood" ? "#66f2b9" : "#ffd066");
      s.material.emissiveColor = BABYLON.Color3.FromHexString(type === "wood" ? "#66f2b9" : "#ffd066").scale(0.8);

      const gl = new BABYLON.PointLight("lootLight", new BABYLON.Vector3(x,1.6,z), scene);
      gl.diffuse = BABYLON.Color3.FromHexString(type === "wood" ? "#66f2b9" : "#ffd066");
      gl.intensity = 0.85;
      gl.range = 12;

      s.parent = dungeonRoot;
      loot.push({ type, mesh:s, light:gl, t: Math.random()*10 });
    }

    // Zone switching
    function setZone(next){
      if (GAME.zone === next) return;
      GAME.zone = next;
      if (next === "dungeon"){
        startRoot.setEnabled(false);
        dungeonRoot.setEnabled(true);
        scene.fogDensity = 0.014;
        scene.fogColor = new BABYLON.Color3(0.015,0.02,0.05);
        showToast("Entered the dungeon.");
      } else {
        startRoot.setEnabled(true);
        dungeonRoot.setEnabled(false);
        scene.fogDensity = 0.008;
        scene.fogColor = new BABYLON.Color3(0.03,0.04,0.08);
        showToast("Returned to start.");
      }
      syncUI();
    }

    // Movement input
    const keys = new Set();
    window.addEventListener("keydown", (e)=>keys.add(e.key.toLowerCase()));
    window.addEventListener("keyup", (e)=>keys.delete(e.key.toLowerCase()));

    // Attack
    let attackCd = 0;
    function doAttack(){
      if (attackCd > 0) return;
      attackCd = 0.22;

      // Quick ‚Äúslash‚Äù ring
      const ring = BABYLON.MeshBuilder.CreateTorus("slash",{ diameter:3.0, thickness:0.08, tessellation:48 },scene);
      ring.position = player.position.clone();
      ring.position.y = 0.12;
      ring.rotation.x = Math.PI/2;
      const m = new BABYLON.StandardMaterial("slashMat", scene);
      m.emissiveColor = new BABYLON.Color3(1,1,1);
      m.alpha = 0.35;
      m.disableLighting = true;
      ring.material = m;

      let k = 0;
      const obs = scene.onBeforeRenderObservable.add(() => {
        const dt = engine.getDeltaTime()/1000;
        k += dt*5.5;
        ring.scaling.setAll(1 + k*0.25);
        ring.material.alpha = Math.max(0, 0.35*(1-k));
        if (k >= 1){
          scene.onBeforeRenderObservable.remove(obs);
          ring.dispose();
        }
      });

      if (GAME.zone !== "dungeon") return;

      // hit crates near player
      const hitR = 2.9;
      for (let i=breakables.length-1; i>=0; i--){
        const b = breakables[i];
        if (!b || b.isDisposed()) { breakables.splice(i,1); continue; }
        const d = BABYLON.Vector3.Distance(player.position, b.position);
        if (d <= hitR){
          b.metadata.hp -= 1;
          b.position.x += (Math.random()<0.5?-0.15:0.15);
          b.position.z += (Math.random()<0.5?-0.15:0.15);
          if (b.metadata.hp <= 0){
            const bx = b.position.x, bz = b.position.z;
            b.dispose();
            breakables.splice(i,1);

            spawnLoot("wood", bx + (Math.random()-0.5)*0.8, bz + (Math.random()-0.5)*0.8);
            if (Math.random() < 0.65) spawnLoot("stone", bx + (Math.random()-0.5)*0.8, bz + (Math.random()-0.5)*0.8);
          }
        }
      }
    }

    // Reliable attack inputs
    canvas.addEventListener("pointerdown", (e) => {
      // First click locks; later clicks attack
      if (document.pointerLockElement !== canvas) {
        canvas.requestPointerLock?.();
        return;
      }
      if (e.isPrimary) doAttack();
    });
    window.addEventListener("keydown", (e) => {
      if (e.code === "Space") { e.preventDefault(); doAttack(); }
    });
    ui.attackBtn.addEventListener("pointerdown", (e)=>{ e.preventDefault(); doAttack(); });

    // Main update loop
    let lastT = performance.now();
    showToast("Click to enable mouse look. Walk into the glowing portal.");

    scene.onBeforeRenderObservable.add(() => {
      const now = performance.now();
      const dt = Math.min(0.05, (now - lastT) / 1000);
      lastT = now;

      // Buddy bob
      buddy.position.y = 0.55 + Math.sin(now*0.006)*0.06;

      // Attack cooldown
      attackCd = Math.max(0, attackCd - dt);

      // Portal pulse
      portalMat.emissiveColor = BABYLON.Color3.FromHexString("#66f2b9").scale(0.55 + 0.35*Math.sin(now*0.003));

      // Movement: correct forward relative to camera yaw
      const sprint = keys.has("shift");
      const speed = sprint ? 10.0 : 7.4;

      let mx = 0, mz = 0;
      if (keys.has("a") || keys.has("arrowleft"))  mx -= 1;
      if (keys.has("d") || keys.has("arrowright")) mx += 1;
      if (keys.has("w") || keys.has("arrowup"))    mz += 1;   // forward
      if (keys.has("s") || keys.has("arrowdown"))  mz -= 1;   // back

      // Normalise diagonal
      const len = Math.hypot(mx, mz);
      if (len > 0){ mx /= len; mz /= len; }

      // Camera yaw direction from ArcRotate alpha
      const yaw = camera.alpha;
      const forward = new BABYLON.Vector3(-Math.sin(yaw), 0, -Math.cos(yaw)); // forward is -Z
      const right   = new BABYLON.Vector3( Math.cos(yaw), 0, -Math.sin(yaw));

      const wish = right.scale(mx).add(forward.scale(mz)).scale(speed);

      // Simple gravity
      velocityY += gravity.y * dt;
      const moveVec = new BABYLON.Vector3(wish.x*dt, velocityY*dt, wish.z*dt);

      // Collisions movement
      player.moveWithCollisions(moveVec);

      // Ground snap
      if (player.position.y < 1.0){
        player.position.y = 1.0;
        velocityY = 0;
      }

      // Face move direction
      if (len > 0.1){
        const face = Math.atan2(wish.x, wish.z);
        player.rotation.y = BABYLON.Scalar.LerpAngle(player.rotation.y, face, 0.18);
      }

      // Zone triggers
      if (GAME.zone === "start"){
        const dx = player.position.x - gate.getAbsolutePosition().x;
        const dz = player.position.z - gate.getAbsolutePosition().z;
        if (dx*dx + dz*dz < 4.7*4.7){
          player.position = new BABYLON.Vector3(0, 1.0, -135);
          velocityY = 0;
          setZone("dungeon");
          pushFeed("üåÄ", "Entered the dungeon.");
        }
      } else {
        // exit corridor
        const dx = player.position.x - 0;
        const dz = player.position.z - (-120);
        if (dx*dx + dz*dz < 5.0*5.0){
          player.position = new BABYLON.Vector3(0, 1.0, -55);
          velocityY = 0;
          setZone("start");
        }

        // Loot bob + magnet pickup
        const MAGNET = 2.6;
        for (let i=loot.length-1;i>=0;i--){
          const p = loot[i];
          if (!p.mesh || p.mesh.isDisposed()){ loot.splice(i,1); continue; }
          p.t += dt;
          p.mesh.position.y = 1.35 + Math.sin(p.t*3.2)*0.16;

          const d = BABYLON.Vector3.Distance(player.position, p.mesh.position);
          if (d < MAGNET){
            // magnet pull
            p.mesh.position.x = BABYLON.Scalar.Lerp(p.mesh.position.x, player.position.x, 0.18);
            p.mesh.position.z = BABYLON.Scalar.Lerp(p.mesh.position.z, player.position.z, 0.18);
            p.light.position.x = p.mesh.position.x;
            p.light.position.z = p.mesh.position.z;

            if (d < 0.55){
              if (p.type === "wood"){ GAME.wood += 1; pushFeed("ü™µ", "Picked up wood. +1"); }
              else { GAME.stone += 1; pushFeed("ü™®", "Picked up stone. +1"); }
              p.light.dispose();
              p.mesh.dispose();
              loot.splice(i,1);
              syncUI();
            }
          }
        }
      }

      syncUI();
    });

    return scene;
  };

  const scene = createScene();
  syncUI();

  engine.runRenderLoop(() => scene.render());
  window.addEventListener("resize", () => engine.resize());
})();
</script>
</body>
</html>
